name: Auto Cert Manager

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

env:
  ALI_KEY: ${{ secrets.ALI_KEY }}
  ALI_SECRET: ${{ secrets.ALI_SECRET }}
  CF_KEY: ${{ secrets.CF_KEY }}
  CF_EMAIL: ${{ secrets.CF_EMAIL }}
  CERT_DIR: "./certs"
  ZIP_PASSWORD: ${{ secrets.MYCERT_PWD }}

jobs:
  cert-manager:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y certbot openssl zip unzip
        pip install --upgrade certbot certbot-dns-aliyun certbot-dns-cloudflare

    - name: Generate AliCloud Certificate
      env:
        ALI_KEY: ${{ secrets.ALI_KEY }}
        ALI_SECRET: ${{ secrets.ALI_SECRET }}
      run: |
        certbot certonly --force-renewal \
          --authenticator dns-aliyun \
          --dns-aliyun-credentials <(echo "dns_aliyun_access_key = $ALI_KEY
dns_aliyun_access_key_secret = $ALI_SECRET") \
          --dns-aliyun-propagation-seconds 60 \
          -d gaoyp.com,*.gaoyp.com,gaotz.com,*.gaotz.com \
          --agree-tos \
          --email $CF_EMAIL \
          --non-interactive \
          --config-dir /tmp/certs/aliyun

        mkdir -p $CERT_DIR/aliyun
        cp /tmp/certs/aliyun/live/gaoyp.com/*.pem $CERT_DIR/aliyun/
        cd $CERT_DIR/aliyun && \
          mv cert.pem gaoyp.com.cer && \
          mv privkey.pem gaoyp.com.key && \
          mv fullchain.pem gaoyp.com.fullchain.cer && \
          zip -q -P "$ZIP_PASSWORD" ../mycert_ali.zip *.cer *.key
        rm -rf $CERT_DIR/aliyun

    - name: Generate Cloudflare Certificate
      env:
        CF_KEY: ${{ secrets.CF_KEY }}
        CF_EMAIL: ${{ secrets.CF_EMAIL }}
      run: |
        certbot certonly --force-renewal \
          --authenticator dns-cloudflare \
          --dns-cloudflare-credentials <(echo "dns_cloudflare_email = $CF_EMAIL
dns_cloudflare_api_key = $CF_KEY") \
          --dns-cloudflare-propagation-seconds 30 \
          -d gaotz.com,*.gaotz.com,gaoyp.com,*.gaoyp.com \
          --agree-tos \
          --email $CF_EMAIL \
          --non-interactive \
          --config-dir /tmp/certs/cloudflare

        mkdir -p $CERT_DIR/cloudflare
        cp /tmp/certs/cloudflare/live/gaotz.com/*.pem $CERT_DIR/cloudflare/
        cd $CERT_DIR/cloudflare && \
          mv cert.pem gaotz.com.cer && \
          mv privkey.pem gaotz.com.key && \
          mv fullchain.pem gaotz.com.fullchain.cer && \
          zip -q -P "$ZIP_PASSWORD" ../mycert_cf.zip *.cer *.key
        rm -rf $CERT_DIR/cloudflare

    - name: Commit Changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add $CERT_DIR/
        git commit -m "Auto-renew certificates $(date +'%Y-%m-%d')"
        git push
